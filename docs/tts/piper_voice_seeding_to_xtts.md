# Piper → reference WAV → XTTS (robust voice seeding)

## Goal

Generate stable per-character reference WAVs deterministically using Piper, then use those WAVs as XTTS speaker references (voice cloning mode). This avoids XTTS speaker-ID lists and prevents failures when XTTS reports `speakers=0`.

## Directory layout (canonical)

- `data/tts/piper_voices/`
  - Stores Piper voice model files (per voice).
- `data/tts/speakers/`
  - Stores generated reference WAVs used by XTTS.
  - Filenames MUST be stable IDs, not raw screenplay text:
    - `<voice_id>.wav`
- `data/tts/voice_map.json`
  - JSON object mapping character identity to stable voice ID:
    - `{ "<character_id>": "<voice_id>", ... }`
  - This file MUST NOT store XTTS speaker IDs.

## Data model (canonical)

### cast_plan character record requirements

Each character MUST have:
- `character_id` (stable, machine key; e.g. `archaeologist`, `god`)
- `display_name` (for script; e.g. `Archaeologist`)
- `voice_id` (stable, machine key; e.g. `piper_en_male_01`)
- `voice_seed_text` (short text used to generate the reference WAV; may be generated by agent)
- `voice_seed_seconds_target` (default 10)

If `voice_seed_text` missing, VoiceSeeder must generate it.

## VoiceSeeder agent (new)

### Responsibility

For each character in cast_plan:
1. Ensure `voice_id` exists.
2. Ensure reference WAV exists: `data/tts/speakers/<voice_id>.wav`
3. If missing, synthesize it using Piper and write the WAV.
4. Update `data/tts/voice_map.json`:
   - `voice_map[character_id] = voice_id`

### Idempotency

- If `data/tts/speakers/<voice_id>.wav` exists, do not regenerate it.
- If `voice_map.json` already maps the character_id to the same voice_id, do not change it.

### Determinism requirements

- VoiceSeeder must run with a fixed seed.
- Piper invocation must be deterministic for identical inputs (same voice model, text, settings).
- VoiceSeeder must normalize output WAV format:
  - 16-bit PCM WAV
  - 22050 Hz (preferred) OR preserve Piper output sample rate consistently
  - single channel (mono)

## Piper synthesis (seed TTS)

### Inputs

- `voice_id` resolved to an installed Piper voice model in `data/tts/piper_voices/`
- `voice_seed_text` (single-speaker clean text, 1–3 short paragraphs)
- settings:
  - `speaker_boost`: off
  - `noise_scale`: default
  - `length_scale`: default

### Output

- `data/tts/speakers/<voice_id>.wav`

### Recommended voice_seed_text constraints

- 60–120 words
- no SFX markers
- no stage directions
- no character name prefixes
- clean punctuation
- language consistent with target content

## XTTS synthesis (runtime TTS)

### Rule

When XTTS reports `speakers=0`, the orchestrator MUST NOT send speaker IDs.

### Inputs per line

- `text`
- `speaker_wav`:
  - `data/tts/speakers/<voice_id>.wav` (resolved via `voice_map.json` or cast_plan `voice_id`)
- optional:
  - `language`
  - `speed`

### Resolution order (must be stable)

Given a line with `character_id`:
1. If cast_plan provides `voice_id`, use it.
2. Else use `voice_map.json[character_id]`.
3. Else fail with a clear error: missing voice_id for character_id.

The orchestrator MUST NOT attempt to infer from `display_name` or raw screenplay speaker text.

## Failure handling

- If Piper seed generation fails:
  - mark the character performance as failed with error `VOICE_SEED_FAILED`
  - do not attempt XTTS for that character
- If XTTS call fails:
  - mark the line failed with error `XTTS_FAILED`
  - do not overwrite seed WAVs

## Caching

- Reference WAVs are persistent assets:
  - never regenerated unless explicitly deleted or a `--force-regenerate-voices` flag is used
- If `--force-regenerate-voices` is enabled:
  - regenerate WAVs for all characters in cast_plan
  - overwrite existing `data/tts/speakers/<voice_id>.wav`

## Minimal pipeline integration points

1. Casting agent MUST emit `character_id`, `display_name`, `voice_id`.
2. VoiceSeeder agent runs before any performance generation.
3. XTTS client uses `speaker_wav` path resolved from `voice_id`.
4. `voice_map.json` is the only mapping used at runtime for character_id → voice_id.

## Example voice_map.json

{
  "archaeologist": "piper_en_male_01",
  "god": "piper_en_deep_02"
}

